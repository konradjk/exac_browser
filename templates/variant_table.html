{% block variant_table %}
{#
{% include 'variant_selectors.html' %}
#}
{% include "variant_table_template.html" %}
<script>
    $(document).ready(function() {

        // This list is simply copied from utils.py.
        // Obviously that's not ideal, but I wanted to keep this diff isolated.
        // I'm also not sure how you want to serve additional context to the client -
        // yet another template variable also seems suboptimal.
        // xBrowse has a variable DICTIONARY in global scope where we store stuff like this -
        // might want to try that!
        var csq_order = ["transcript_ablation",
            "splice_donor_variant",
            "splice_acceptor_variant",
            "stop_gained",
            "frameshift_variant",
            "stop_lost",
            "initiator_codon_variant",
            "transcript_amplification",
            "inframe_insertion",
            "inframe_deletion",
            "missense_variant",
            "splice_region_variant",
            "incomplete_terminal_codon_variant",
            "stop_retained_variant",
            "synonymous_variant",
            "coding_sequence_variant",
            "mature_miRNA_variant",
            "5_prime_UTR_variant",
            "3_prime_UTR_variant",
            "non_coding_transcript_exon_variant",
            "non_coding_exon_variant",
            "intron_variant",
            "NMD_transcript_variant",
            "non_coding_transcript_variant",
            "nc_transcript_variant",
            "upstream_gene_variant",
            "downstream_gene_variant",
            "TFBS_ablation",
            "TFBS_amplification",
            "TF_binding_site_variant",
            "regulatory_region_ablation",
            "regulatory_region_amplification",
            "regulatory_region_variant",
            "feature_elongation",
            "feature_truncation",
            "intergenic_variant",
        ""];

        // Make a map of consequence -> index
        // That'll be the actual sort key, so lower i => more severe consequence
        var csq_order_index = {};
        _.each(csq_order, function(c, i) {
            csq_order_index[c] = i;
        });

        // group and count consequences by number of variants for filter buttons
        var consequence_to_count = _.countBy(_.map(table_variants, function(v) {
            return v.major_consequence;
        }));

        var consequences = [
           "3_prime_UTR_variant",
           "5_prime_UTR_variant",
           "frameshift_deletion",
           "inframe_deletion",
           "frameshift_insertion",
           "inframe_insertion",
           "missense_variant",
           "stop_lost",
           "splice",
           "intergenic",
           "intronic",
           "nonsense",
           "silent",
           "upstream"
           ];
        consequence_counts = _.sortBy(_.map(consequences, function(csq) {
            return [csq, consequence_to_count[csq] ? consequence_to_count[csq] : 0];
        }), function(csq_count) {
            return -csq_count[1];
        });

        $("#variants_loading").hide();
        $("#variants_table_container").show();
        window.variants_template = _.template($('#variant-table-template').html());
        $('#variants_table_container').html(variants_template({
            table_variants: table_variants,
            consequence_counts: consequence_counts
        }));

        $("#variant_table").tablesorter({
            sortList: [[4,0]],  // initial sort is cHGVS ascending
            widgets: ["stickyHeaders"]
        });

{#                .tablesorterPager({container: $("#pager"), positionFixed: false});#}
{#        if (window.table_variants.length <= 10) {#}
            $('#pager').hide();
{#        }#}

        function get_af_category(d) {
            if (!d.allele_freq) {
                return [0, '0'];
            } else if (d.allele_count == 1) {
                return [1, 'a singleton'];
            } else if (d.allele_freq < 1/10000) {
                return [2, '<1/10000'];
            } else if (d.allele_freq < 1/1000) {
                return [3, '1/10000-0.001'];
            } else if (d.allele_freq < 1/100) {
                return [4, '0.001-0.01'];
            } else if (d.allele_freq < 1/20) {
                return [5, '0.01-0.05'];
            } else if (d.allele_freq < 1/2) {
                return [6, '0.05-0.5'];
            } else {
                return [7, '0.5-1'];
            }
        }

        var data = window.table_variants;

        var width = 50;
        var height = 15;

        var x_scale = d3.scale.linear()
            .domain([0, 7])
            .range([0, width]);

        var svg;
        $.each(data, function(i, d) {
            d3.select('#variant_af_box_' + d.variant_id).attr("data-tooltip", "Shows allele frequency \n on a discrete " +
                    "scale: \n singletons, <1/10,000, \n <1/1000, <1%, <5%, \n <50%, >50%. \n This particular variant is \n " +
                    get_af_category(d)[1] + ".");
            svg = d3.select('#variant_af_box_' + d.variant_id)
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g");

            for (var j=0; j<8; j++) {
                svg.append('rect')
                        .style('stroke', 'steelblue')
                        .style('fill', 'white')
                        .attr('x', x_scale(j))
                        .attr('y', 0)
                        .attr('height', height)
                        .attr('width', x_scale(1) - x_scale(0))
            }

            svg.append('rect')
                .style('fill', 'steelblue')
                .attr('x', 0)
                .attr('y', 0)
                .attr('width', function() {
                    return x_scale(get_af_category(d)[0]);
                })
                .attr('height', height);

        });
        update_variants();
        $("#export_to_csv").on('click', function (event) {
            var output_name = window.page_name === undefined ? 'export' : window.page_name;
            var timestamp = date_format(new Date());
            exportTableToCSV.apply(this, [$('#variant_table'), 'whi_' + output_name + '_' + timestamp + '.csv']);
        });

        $('.consequence_display_buttons').on('change click', function (event) {
            target = $(event.currentTarget);
            if (target.hasClass('disabled')) return;

            $('.consequence_display_buttons.active').removeClass('active');
            target.addClass('active');
            $('#filter-dropdown').text(target.text());

            setTimeout(function() {
                update_variants();
                // update_cnvs();
                // refresh_links();
            }, 10);
        });
    });
</script>

<div id="variants_loading">Loading variants...</div>
<div id="variants_table_container" class="row" style="display: none;"></div>
<div id="variants_table_empty" style="display: none;">No variants found.</div>
{% endblock %}
